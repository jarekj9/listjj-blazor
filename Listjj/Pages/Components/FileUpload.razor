@using System
@using System.IO
@using Listjj.Pages
@inherits PageBase


<InputFile id="fileInput" OnChange="UploadFiles" hidden multiple />

<MudFab HtmlTag="label"
        Color="Color.Success"
        Icon="@Icons.Filled.AttachFile"
        for="fileInput" />

@if (files != null)
{
    <MudText Typo="@Typo.h6">@files.Count() File@(files.Count() == 1 ? "" : "s"):</MudText>
    <MudList>
    @foreach (var file in files)
    {
     <MudListItem Icon="@Icons.Filled.AttachFile" @key="@file">
         @file.Name <code>@file.Size bytes</code>
     </MudListItem>
    }
    </MudList>
}
@code
{
    IList<IBrowserFile> files = new List<IBrowserFile>();
    [Parameter] public Guid NoteId {get; set;}
    private async Task UploadFiles(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            files.Add(file);
            MemoryStream ms = new MemoryStream();
            await file.OpenReadStream(5000000).CopyToAsync(ms);
            var bytes = ms.ToArray();
            
            var item = FileService.AddFile(NoteId, bytes, file.Name);
            
            // Saving to disk:
            try
            {
                using var fs = new FileStream(file.Name, FileMode.Create, FileAccess.Write);
                fs.Write(bytes, 0, bytes.Length);
            }
            catch (Exception ex)
            {
                Console.WriteLine("Exception caught in process: {0}", ex);
                throw;
            }


        }
        //TODO upload the files to the server
    }


}